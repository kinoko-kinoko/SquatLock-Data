name: Request Intake (generate pending JSON)

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 2 * * *"  # æ¯æ—¥ 02:00 UTC

permissions:
  contents: write
  pull-requests: write

env:
  SHEET_ID: "1OwFBKIJVqLGJVOWc-uRkokUoMm_0BBvwBQloc09ViZA"   # ä¾‹: 1AbCdEFG...
  SHEET_GID: "1702853255"       # ä¾‹: 123456789

jobs:
  intake:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure dirs
        run: |
          mkdir -p pending/requests
          # ç©ºã‚³ãƒŸãƒƒãƒˆé˜²æ­¢ã®ãŸã‚ .gitkeep ã‚’ç¶­æŒ
          [ -f pending/requests/.gitkeep ] || echo "" > pending/requests/.gitkeep

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: python -m pip install --upgrade pip

      # ğŸ”½ ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰ CSV ã‚’ç›´æ¥å–å¾—
      - name: Fetch form CSV from Google Sheets
        run: |
          set -euxo pipefail
          URL="https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}"
          curl -fL "$URL" -o pending/requests/inbox.csv
          echo "=== CSV head ==="
          head -n 5 pending/requests/inbox.csv || true

      # ï¼ˆãƒ˜ãƒƒãƒ€åã®ç°¡æ˜“å¤‰æ›ãŒå¿…è¦ãªã‚‰ã“ã“ã§ sed ãªã©ã‚’ä½¿ç”¨ï¼‰
      # ä¾‹ï¼šãƒ•ã‚©ãƒ¼ãƒ ã®åˆ—åãŒã€ŒApp nameã€ã€ŒCountryã€ã®å ´åˆã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆæƒ³å®šã®
      #     app_name,country ã«åˆã‚ã›ã‚‹
      - name: Normalize CSV headers (optional)
        run: |
          set -e
          # å…ˆé ­1è¡Œã ã‘ç½®æ›ï¼ˆå¿…è¦ãªå ´åˆã ã‘æ®‹ã™ï¼‰
          # macOS ã¨é•ã„ GNU sed ãªã®ã§ -i ãã®ã¾ã¾ã§OK
          sed -i '1 s/^[[:space:]]*App name[[:space:]]*,[[:space:]]*Country[[:space:]]*$/app_name,country/i' pending/requests/inbox.csv || true

      - name: Generate pending JSON
        run: |
          python scripts/request_to_pending.py pending/requests/inbox.csv
          echo "== files in pending/requests =="
          ls -la pending/requests || true

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "feat(pending): intake user requests"
          title: "feat(pending): intake user requests"
          body: |
            ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ï¼ˆã‚¢ãƒ—ãƒªåã®ã¿ï¼‰ã‹ã‚‰ pending/requests/*.json ã‚’è‡ªå‹•ç”Ÿæˆã€‚
            - schemes ã¯ç©ºï¼ˆå¾Œã§ä¿å®ˆè€…ãŒè¿½è¨˜ï¼‰
            - universalLinks / webHosts / categories ã¯è‡ªå‹•æ¨æ¸¬
          branch: intake/pending-json
          labels: pending, intake
          add-paths: |
            pending/requests/*.json
